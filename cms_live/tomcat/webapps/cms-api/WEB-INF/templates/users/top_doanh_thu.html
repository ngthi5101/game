<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">

	<head>

		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<link rel="icon" type="image/png" sizes="96x96"
			  href="/favicon-96x96.png"
			  th:href="@{/resources/dashboard_files/favicon.png}" />

		<title data-th-text="#{admin.page.title}">Doanh Số</title>

		<!-- Core CSS - Include with every page -->
		<link href="../css/bootstrap.min.css" rel="stylesheet"
			  th:href="@{/resources/sb-admin-v2/css/bootstrap.min.css}" />
		<link href="../font-awesome/css/font-awesome.css" rel="stylesheet"
			  th:href="@{/resources/sb-admin-v2/font-awesome/css/font-awesome.css}" />
		<link href="../bootstrap-daterangepicker/daterangepicker-bs3.css"
			  rel="stylesheet" type="text/css" media="all"
			  th:href="@{/resources/bootstrap-daterangepicker/daterangepicker-bs3.css}" />
		<!-- Page-Level Plugin CSS - Dashboard -->
		<link href="../css/plugins/dataTables/dataTables.bootstrap.css"
			  rel="stylesheet"
			  th:href="@{/resources/sb-admin-v2/css/plugins/dataTables/dataTables.bootstrap.css}" />
		<!-- SB Admin CSS - Include with every page -->
		<link href="../css/sb-admin.css" rel="stylesheet"
			  th:href="@{/resources/sb-admin-v2/css/sb-admin.css}" />

	</head>

	<body>

		<div id="wrapper">
			<div th:if="${userType} == 1">
				<div data-th-replace="fragments/sb-admin :: top-nav"></div>
				<div data-th-replace="fragments/sb-admin :: vert-nav-admin"></div>
			</div>
			<div th:if="${userType} == 2">
				<div data-th-replace="fragments/sb-admin :: top-nav"></div>
				<div data-th-replace="fragments/sb-admin :: vert-nav-admin"></div>
			</div>		
			<div th:if="${userType} == 3">
				<div data-th-replace="cskh/sb-care :: top-nav"></div>
				<div data-th-replace="cskh/sb-care :: vert-nav-admin"></div>
			</div>
			<div id="page-wrapper">
				<div class="row">
					<div class="col-lg-12">
						<h1 class="page-header">
							Top Doanh số tổng Mua + Bán 
							<span th:if="${user_type == 'agency_level_1'}">Đại lí cấp 1</span>
							<span th:if="${user_type == 'agency_level_2'}">Đại lí cấp 2</span>
							<span th:if="${user_type == 'haywin'}">Khách thường</span>
							<span th:if="${user_type == 'all'}"> của C1 và C2</span>
						</h1>
					</div>
					<!-- /.col-lg-12 -->
				</div>

				<div class="row" sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_TONG',  'ROLE_C1')">
					<div class="panel-body">
						<form role="form" method="post" action="/users/list.html"
							  th:action="@{/users/top_doanh_thu.html}">
							<div class="row">
								<div class="col-lg-3"  sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_TONG')"  th:if="${user_type == 'agency_level_2'}">
                                    <label>ID đại lí cấp 1</label>
									<input type="text" name = "agen_lv_1" th:value="${agen_lv_1}" class="form-control span4"/>
                                </div>
                                <div class="col-lg-3" >
                                    <label>Từ ngày - đến ngày</label>
                                    <div class="input-prepend input-group">
                                        <span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
                                        <input type="text" name = "from_date" id = "from_date" hidden="true" th:value="${from_date}"/>
                                        <input type="text" name = "to_date" id = "to_date" hidden="true"  th:value="${to_date}"/> 
                                        <input type="text" style="width: 100%" name="date_range" id="reservationtime" class="form-control span4"
                                               value="08/01/2013 - 08/01/2013" th:value="${from_date} + ' - ' + ${to_date}" readonly="readonly" />
                                    </div>
                                </div>
								<div class="col-lg-3" style="display: none;">
                                    <label>Loại</label>
                                    <div>
                                        <select name="user_type" class="form-control">
											<option value="agency_level_1" th:selected="${agency_level_1 == 'all'}">Đại lí cấp 1</option>
											<option value="agency_level_2" th:selected="${user_type == 'agency_level_2'}">Đại lí cấp 2</option>
											<option value="haywin" th:selected="${haywin == 'all'}">Người chơi thường</option>
										</select>
                                    </div>
								</div>
								<div class="col-lg-2">
										<label>&nbsp;</label>
										<div>
											<button type="submit" class="btn btn-info">Gửi</button>
										</div>
									</div>
								<br />
							</div>
						</form>
						<!-- /.row (nested) -->
					</div>
				</div>
				<!-- /.row -->
				<div class="row">
					<div class="col-lg-12">

						<div class="panel panel-primary" >
							<div class="panel-heading">Danh sách người chơi</div>
							<!-- /.panel-heading -->
							<div class="panel-body">
								<div class="table-responsive" >
									<p>Tổng doanh thu (bán + mua) của các người dùng trong danh sách: <span class="total_user_gold">0</span></p>
									<p>Tổng tiền bán của tất cả người dùng trong danh sách: <span class="total_user_sell"></span></p>
									<p>Tổng tiền mua của tất cả người dùng trong danh sách: <span class="total_user_buy"></span></p>
									<p id="sum_gold" th:text="${sum_gold}" style="display: none;"></p>
									<table class="table table-striped table-bordered table-hover"
										   id="dataTables-userTop">
										<thead>
											<tr>
												<th>ID</th>
												<th>Full Name</th>
												<th>Bán</th>
												<th>Mua</th>
												<th>Tổng</th>
												<!--											<th>+</th>-->
											</tr>
										</thead>
										<!--                                                                    Khai báo biến total-->
										<tbody>
											<tr class="odd gradeX row_cont" th:each="oneUser : ${tops}">
												<td><span th:text="${oneUser.id}"></span></td>
												<td><span th:text="${oneUser.fullname}"></span></td>
												<td th:text="${#numbers.formatDecimal(oneUser.out, 0, 'COMMA', 0, 'POINT')}" class="center out_value"></td>
												<td th:text="${#numbers.formatDecimal(oneUser.in, 0, 'COMMA', 0, 'POINT')}" class="center in_value"></td>
												<td th:text="${oneUser.total}" class="center user_gold_amount">0</td>
												<!--											<td><a href="add_money.html?user_id=1'"
																								th:href="@{'/users/detail.html?user_id=' + ${oneUser.id}}">Cộng
																									tài khoản</a></td>-->
											</tr>
										</tbody>
									</table>
								</div>
								<!-- /.table-responsive -->
							</div>
							<!-- /.panel-body -->
						</div>
					</div>
					<!-- /.panel -->
				</div>
				<!-- /.col-lg-12 -->
			</div>
			<!-- /.row -->
		</div>
		<!-- /#page-wrapper -->
		<!-- /#wrapper -->
		<style>
			.user_gold_amount, .total_user_gold{color: red;font-weight: bold;}
			.user_gold_amount{background: #fff7d9 !important;}
			.total_user_sell, .out_value{color: #169a1a;font-weight: bold;}
			.total_user_buy, .in_value{color: #3c87bd;font-weight: bold;}
		</style>

		<!-- Core Scripts - Include with every page -->
		<script src="../js/jquery-1.10.2.js"
		th:src="@{/resources/sb-admin-v2/js/jquery-1.10.2.js}"></script>
		<script src="../js/bootstrap.min.js"
		th:src="@{/resources/sb-admin-v2/js/bootstrap.min.js}"></script>
		<script src="../js/plugins/metisMenu/jquery.metisMenu.js"
		th:src="@{/resources/sb-admin-v2/js/plugins/metisMenu/jquery.metisMenu.js}"></script>

		<!-- Page-Level Plugin Scripts - Tables -->
		<script src="../js/plugins/dataTables/jquery.dataTables.js"
		th:src="@{/resources/sb-admin-v2/js/plugins/dataTables/jquery.dataTables.js}"></script>
		<script src="../js/plugins/dataTables/dataTables.bootstrap.js"
		th:src="@{/resources/sb-admin-v2/js/plugins/dataTables/dataTables.bootstrap.js}"></script>


		<!-- SB Admin Scripts - Include with every page -->
		<script src="../js/sb-admin.js"
		th:src="@{/resources/sb-admin-v2/js/sb-admin.js}"></script>

		<!-- Page-Level Demo Scripts - Tables - Use for reference -->
		<script type="text/javascript"
				src="../bootstrap-daterangepicker/moment.js"
		th:src="@{/resources/bootstrap-daterangepicker/moment.js}"></script>
		<script type="text/javascript"
				src="../bootstrap-daterangepicker/daterangepicker.js"
		th:src="@{/resources/bootstrap-daterangepicker/daterangepicker.js}"></script>
		<script>
			$(document).ready(function () {
				/*$('#dataTables-user').dataTable();
				 $('#dataTables-example').dataTable();
				 // $('#dataTables-userTop').dataTable();
				 $('#dataTables-userTop').dataTable({
				 "order" : [ [ 5, "desc" ] ]
				 });*/
				$('#dataTables-userTop').dataTable();
				$('#reservationtime').daterangepicker({
					timePicker: false,
					format: 'YYYY/MM/DD'
				}, function (start, end, label) {
					console.log('A date range was chosen: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
					$('#from_date').val(start.format('YYYY-MM-DD'));
					$('#to_date').val(end.format('YYYY-MM-DD'));
				});
				$('.row_cont').each((i, o) => {
					var in_value = parseInt($(o).find(".in_value").text().replaceAll(",", ""));
					var out_value = parseInt($(o).find(".out_value").text().replaceAll(",", ""));
				});
				setTimeout(() => {
					$('.dataTable th.sorting:last-child').click();
					setTimeout(() => {
						$('.dataTable th.sorting_asc:last-child').click();
						autoFormatEachTotal();
						setInterval(autoFormatEachTotal, 2000);
					}, 100);
				}, 0);
			});
			function autoFormatEachTotal(){
				var $ = jQuery;
				var sum_all_user_gold = 0;
				$('.user_gold_amount').each((i, o) => {
					sum_all_user_gold += parseInt($(o).text().replaceAll(",", ""));
					$(o).text(numberWithCommas($(o).text()));
				});
				$('.total_user_gold').text(numberWithCommas(sum_all_user_gold));
				
				var total_user_sell = 0;
				$('td.out_value').each((i, o) => {
					total_user_sell += parseInt($(o).text().replaceAll(",", ""));
				});
				$('.total_user_sell').text(numberWithCommas(total_user_sell));
				var total_user_buy = 0;
				$('td.in_value').each((i, o) => {
					total_user_buy += parseInt($(o).text().replaceAll(",", ""));
				});
				$('.total_user_buy').text(numberWithCommas(total_user_buy));
			}
			
			function doSearchUser() {
				/* window.location.href = '@{/users/list.html?fullname=}' + $(".custom-search-form > input").val(); */
				window.location.href = $('#idSearchLink').val()
						+ $("#idSearchValue").val() + ';;;'
						+ $("#idSearchValueMobile").val();
				return false;
			};
			String.prototype.replaceAll = function (search, replacement) {
				var target = this;
				return target.replace(new RegExp(search, 'g'), replacement);
			};
			const numberWithCommas = (x) => {
				return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
			}
		</script>
	</body>

</html>
